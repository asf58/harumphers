<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HARUMPHERS Directory</title>
  <meta name="theme-color" content="#8B0000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #1a1a1a;
      color: #fff;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #8B0000 0%, #4a0000 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    header img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 20px;
      flex: 1;
    }

    .header-links {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .back-link, .logout-link {
      color: #FFD700;
      text-decoration: none;
      font-size: 14px;
      white-space: nowrap;
    }

    .logout-link { opacity: 0.7; }
    .logout-link:hover { opacity: 1; }

    .search-bar {
      padding: 12px 20px;
      background: #222;
      position: sticky;
      top: 72px;
      z-index: 9;
    }

    .search-bar input {
      width: 100%;
      padding: 10px 16px;
      border-radius: 20px;
      border: 1px solid #444;
      background: #333;
      color: #fff;
      font-size: 16px;
      outline: none;
    }

    .search-bar input::placeholder { color: #888; }
    .search-bar input:focus { border-color: #FFD700; }

    .member-count {
      text-align: center;
      padding: 8px;
      font-size: 13px;
      color: #888;
    }

    .members {
      padding: 8px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 14px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .card:active { background: #333; }

    .avatar {
      width: 112px;
      height: 112px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      background: #444;
    }

    .initials {
      width: 112px;
      height: 112px;
      border-radius: 50%;
      background: #8B0000;
      color: #FFD700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      flex-shrink: 0;
    }

    .info { flex: 1; min-width: 0; }

    .name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .contact {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .contact a {
      color: #FFD700;
      text-decoration: none;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .contact a:active { opacity: 0.7; }

    .loading, .error {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #333;
      border-top-color: #FFD700;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error { color: #ff6b6b; }

    .error a {
      color: #FFD700;
      display: inline-block;
      margin-top: 12px;
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      overflow-y: auto;
      padding: 20px;
    }

    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .detail {
      background: #2a2a2a;
      border-radius: 20px;
      width: 90%;
      max-width: 380px;
      padding: 32px 24px;
      text-align: center;
      position: relative;
    }

    .detail-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: #888;
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
    }

    .detail-close:active { color: #fff; }

    .detail .avatar {
      width: 180px;
      height: 180px;
      margin: 0 auto 16px;
      display: block;
    }

    .detail .initials {
      width: 180px;
      height: 180px;
      font-size: 56px;
      margin: 0 auto 16px;
    }

    .detail-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .detail-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px;
      border-radius: 12px;
      text-decoration: none;
      font-size: 17px;
      font-weight: 600;
    }

    .detail-btn.call {
      background: #FFD700;
      color: #8B0000;
    }

    .detail-btn.email {
      background: rgba(255,215,0,0.15);
      color: #FFD700;
      border: 1px solid #FFD700;
    }

    .detail-btn.edit {
      background: rgba(255,255,255,0.1);
      color: #aaa;
      border: 1px solid #555;
      cursor: pointer;
      border: none;
      font-family: inherit;
    }

    .detail-btn:active { opacity: 0.7; }

    .detail-btn svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Edit / Admin edit form */
    .edit-form {
      text-align: left;
      margin-top: 16px;
      border-top: 1px solid #444;
      padding-top: 16px;
    }

    .edit-form-title {
      font-size: 15px;
      font-weight: 600;
      color: #FFD700;
      margin-bottom: 12px;
      text-align: center;
    }

    .edit-field {
      margin-bottom: 10px;
    }

    .edit-field label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .edit-field input, .edit-field textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #333;
      color: #fff;
      font-size: 15px;
      outline: none;
      font-family: inherit;
    }

    .edit-field input:focus, .edit-field textarea:focus {
      border-color: #FFD700;
    }

    .edit-field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .edit-field input[type="file"] {
      padding: 8px;
      font-size: 13px;
    }

    .edit-submit {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: #FFD700;
      color: #8B0000;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      margin-top: 4px;
    }

    .edit-submit:active { opacity: 0.7; }
    .edit-submit:disabled { opacity: 0.4; cursor: not-allowed; }

    .edit-msg {
      text-align: center;
      padding: 8px 0 0;
      font-size: 13px;
      min-height: 24px;
    }

    .edit-msg.success { color: #4CAF50; }
    .edit-msg.error { color: #ff6b6b; }

    .edit-note {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 8px;
      font-style: italic;
    }

    .you-badge {
      display: inline-block;
      font-size: 10px;
      background: rgba(255,215,0,0.2);
      color: #FFD700;
      padding: 1px 6px;
      border-radius: 6px;
      margin-left: 6px;
      font-weight: 600;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header>
    <img src="apple-touch-icon.png" alt="">
    <h1>HARUMPHERS</h1>
    <div class="header-links">
      <a href="index.html" class="back-link">Home</a>
      <a href="#" class="logout-link" onclick="logout()">Logout</a>
    </div>
  </header>

  <div class="search-bar">
    <input type="search" id="search" placeholder="Search members..." autocomplete="off">
  </div>

  <div id="count" class="member-count"></div>
  <div id="content" class="members">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading directory...</p>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="detail" id="detail"></div>
  </div>

  <script>
    // --- Auth Helpers ---
    function getAuthMode() {
      const auth = localStorage.getItem('harumphers_auth');
      if (auth === 'admin') return 'admin';
      if (auth === 'member') return 'member';
      if (auth === 'guest' || auth === '1') return 'guest';
      return null;
    }

    function getMemberInfo() {
      const recordId = localStorage.getItem('harumphers_member_id');
      const name = localStorage.getItem('harumphers_member_name');
      const duqId = localStorage.getItem('harumphers_duq_id');
      if (!recordId) return null;
      return { recordId, name, duqId };
    }

    function logout() {
      localStorage.removeItem('harumphers_auth');
      localStorage.removeItem('harumphers_member_id');
      localStorage.removeItem('harumphers_member_name');
      localStorage.removeItem('harumphers_duq_id');
      localStorage.removeItem('harumphers_myname');
      window.location.href = 'index.html';
    }

    function requireAuth() {
      if (!getAuthMode()) {
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    if (!requireAuth()) throw new Error('Not authenticated');

    const authMode = getAuthMode();
    const myInfo = getMemberInfo();

    const API_TOKEN = 'patAgD7FQMKDOntHs.c85c0298f3ed1479cec458d9fbb27a5b562b63da5274f287f5e3f156b847f148';
    const BASE_ID = 'appW7Df1qJlznxxtf';
    const TABLE_ID = 'tbltzPyERz9wGE0zd';
    const CHANGES_TABLE = 'tbljI55IdCDB0uFuS';

    let allMembers = [];
    let allRecords = [];

    async function applyApprovedChanges() {
      try {
        const res = await fetch(
          `https://api.airtable.com/v0/${BASE_ID}/${CHANGES_TABLE}?filterByFormula=AND({STATUS}="Approved",{APPLIED AT}=BLANK())`,
          { headers: { 'Authorization': `Bearer ${API_TOKEN}` } }
        );
        if (!res.ok) return;
        const data = await res.json();
        for (const rec of data.records) {
          const f = rec.fields;
          const memberId = f['MEMBER RECORD ID'];
          const changes = f['REQUESTED CHANGES'] || '';
          if (!memberId) continue;

          const updates = {};
          for (const line of changes.split('\n')) {
            const match = line.match(/^(.+?):\s*.+?\s*->\s*(.+)$/);
            if (!match) continue;
            const field = match[1].trim();
            const newVal = match[2].trim();
            if (field === 'Name') updates['FULL NAME'] = newVal;
            else if (field === 'Phone') updates['CELL #'] = newVal;
            else if (field === 'Email') updates['E-MAIL ADDRESS'] = newVal;
          }

          if (Object.keys(updates).length > 0) {
            await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}/${memberId}`, {
              method: 'PATCH',
              headers: { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({ fields: updates })
            });
          }

          await fetch(`https://api.airtable.com/v0/${BASE_ID}/${CHANGES_TABLE}/${rec.id}`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'APPLIED AT': new Date().toISOString() } })
          });
        }
      } catch (e) {
        console.log('Auto-apply check:', e.message);
      }
    }

    async function apiFetchAll(url) {
      let allRecords = [];
      let fetchUrl = url;
      while (true) {
        const res = await fetch(fetchUrl, {
          headers: { 'Authorization': `Bearer ${API_TOKEN}` }
        });
        if (!res.ok) throw new Error(`API error ${res.status}`);
        const data = await res.json();
        allRecords = allRecords.concat(data.records);
        if (!data.offset) break;
        const sep = fetchUrl.includes('?') ? '&' : '?';
        fetchUrl = url + sep + 'offset=' + encodeURIComponent(data.offset);
      }
      return { records: allRecords };
    }

    async function loadDirectory() {
      const params = new URLSearchParams({
        'filterByFormula': '{IN DIRECTORY}=TRUE()',
        'sort[0][field]': 'LAST NAME',
        'sort[0][direction]': 'asc',
      });
      ['FULL NAME', 'PHOTO', 'CELL #', 'E-MAIL ADDRESS', 'MEMBER #'].forEach(f => {
        params.append('fields[]', f);
      });

      const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}?${params}`;

      const data = await apiFetchAll(url);
      allRecords = data.records;
      allMembers = data.records.map(r => {
        const f = r.fields;
        const photo = f['PHOTO'] && f['PHOTO'][0];
        return {
          recordId: r.id,
          name: f['FULL NAME'] || '',
          phone: f['CELL #'] || '',
          email: f['E-MAIL ADDRESS'] || '',
          memberNum: f['MEMBER #'] || '',
          photoUrl: photo && photo.thumbnails && photo.thumbnails.large
            ? photo.thumbnails.large.url : null,
        };
      });

      render(allMembers);
    }

    function render(members) {
      const content = document.getElementById('content');
      const countEl = document.getElementById('count');

      if (members.length === 0) {
        content.innerHTML = '<div class="no-results">No members found</div>';
        countEl.textContent = '';
        return;
      }

      countEl.textContent = `${members.length} member${members.length !== 1 ? 's' : ''}`;

      content.innerHTML = members.map(m => {
        const name = m.name;
        const words = name.split(/\s+/);
        const initials = words.length > 1
          ? `${words[0][0]}${words[words.length-1][0]}`.toUpperCase()
          : (words[0] || '').substring(0,2).toUpperCase();

        const avatarHtml = m.photoUrl
          ? `<img class="avatar" src="${m.photoUrl}" alt="" loading="lazy" onerror="this.outerHTML='<div class=\\'initials\\'>${initials}</div>'">`
          : `<div class="initials">${initials}</div>`;

        let contactHtml = '';
        if (m.phone) {
          const digits = m.phone.replace(/\D/g, '');
          contactHtml += `<a href="tel:+1${digits}">${m.phone}</a>`;
        }
        if (m.email) {
          contactHtml += `<a href="mailto:${m.email}">${m.email}</a>`;
        }

        const isMe = myInfo && m.recordId === myInfo.recordId;
        const youBadge = isMe ? '<span class="you-badge">You</span>' : '';

        const idx = allMembers.indexOf(m);
        return `<div class="card" onclick="showDetail(${idx})">
          ${avatarHtml}
          <div class="info">
            <div class="name">${name}${youBadge}</div>
            <div class="contact">${contactHtml}</div>
          </div>
        </div>`;
      }).join('');
    }

    document.getElementById('search').addEventListener('input', e => {
      const q = e.target.value.toLowerCase().trim();
      if (!q) { render(allMembers); return; }
      const filtered = allMembers.filter(m =>
        `${m.name} ${m.phone} ${m.email}`.toLowerCase().includes(q)
      );
      render(filtered);
    });

    let editFormVisible = false;

    function showDetail(idx) {
      editFormVisible = false;
      const m = allMembers[idx];
      if (!m) return;
      renderDetail(idx);
      document.getElementById('overlay').classList.add('open');
    }

    function renderDetail(idx) {
      const m = allMembers[idx];
      const name = m.name;
      const words = name.split(/\s+/);
      const initials = words.length > 1
        ? `${words[0][0]}${words[words.length-1][0]}`.toUpperCase()
        : (words[0] || '').substring(0,2).toUpperCase();

      const avatarHtml = m.photoUrl
        ? `<img class="avatar" src="${m.photoUrl}" alt="" onerror="this.outerHTML='<div class=\\'initials\\'>${initials}</div>'">`
        : `<div class="initials">${initials}</div>`;

      const isMe = myInfo && m.recordId === myInfo.recordId;

      let actionsHtml = '';
      if (m.phone) {
        const digits = m.phone.replace(/\D/g, '');
        actionsHtml += `<a class="detail-btn call" href="tel:+1${digits}">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.58.57 1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.58 1 1 0 01-.25 1.02l-2.2 2.19z"/></svg>
          ${m.phone}</a>`;
      }
      if (m.email) {
        actionsHtml += `<a class="detail-btn email" href="mailto:${m.email}">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          ${m.email}</a>`;
      }

      // --- Auth-conditional edit button ---
      if (authMode === 'admin') {
        // Admin: direct edit on all cards
        actionsHtml += `<button class="detail-btn edit" onclick="toggleEditForm(${idx})">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Member</button>`;
      } else if (authMode === 'member' && !isMe) {
        // Member: request change on other people's cards only
        actionsHtml += `<button class="detail-btn edit" onclick="toggleEditForm(${idx})">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Request Info Change</button>`;
      }
      // Guest: no edit button at all
      // Member on own card: no edit button (they edit via profile on home screen)

      let editForm = '';
      if (editFormVisible) {
        if (authMode === 'admin') {
          // Admin: direct edit form
          editForm = `
            <div class="edit-form">
              <div class="edit-form-title">Edit Member</div>
              <div class="edit-field">
                <label>Name</label>
                <input type="text" id="edit-name" value="${m.name}" placeholder="Full name">
              </div>
              <div class="edit-field">
                <label>Phone</label>
                <input type="tel" id="edit-phone" value="${m.phone}" placeholder="(412) 555-1234">
              </div>
              <div class="edit-field">
                <label>Email</label>
                <input type="email" id="edit-email" value="${m.email}" placeholder="email@example.com">
              </div>
              <div class="edit-field">
                <label>Member # (Duquesne ID)</label>
                <input type="number" id="edit-membernum" value="${m.memberNum}" placeholder="e.g. 9566">
              </div>
              <div class="edit-field">
                <label>Photo URL</label>
                <input type="url" id="edit-photo-url" placeholder="https://... (public image URL)">
                <div style="font-size:11px;color:#666;margin-top:4px;">Paste a publicly accessible image URL</div>
              </div>
              <button class="edit-submit" id="edit-submit-btn" onclick="adminSaveEdit(${idx})">Save Changes</button>
              <div class="edit-msg" id="edit-msg"></div>
            </div>`;
        } else {
          // Member: change request form
          editForm = `
            <div class="edit-form">
              <div class="edit-form-title">Request Changes</div>
              <div class="edit-field">
                <label>Name</label>
                <input type="text" id="edit-name" value="${m.name}" placeholder="Full name">
              </div>
              <div class="edit-field">
                <label>Phone</label>
                <input type="tel" id="edit-phone" value="${m.phone}" placeholder="(412) 555-1234">
              </div>
              <div class="edit-field">
                <label>Email</label>
                <input type="email" id="edit-email" value="${m.email}" placeholder="email@example.com">
              </div>
              <div class="edit-field">
                <label>New Photo</label>
                <input type="file" id="edit-photo" accept="image/*">
              </div>
              <div class="edit-field">
                <label>Notes</label>
                <textarea id="edit-notes" placeholder="Any other changes or notes..."></textarea>
              </div>
              <button class="edit-submit" id="edit-submit-btn" onclick="submitChangeRequest(${idx})">Submit Request</button>
              <div class="edit-msg" id="edit-msg"></div>
              <div class="edit-note">Changes require admin approval before going live.</div>
            </div>`;
        }
      }

      document.getElementById('detail').innerHTML = `
        <button class="detail-close" onclick="closeDetail()">&times;</button>
        ${avatarHtml}
        <div class="detail-name">${name}</div>
        <div class="detail-actions">${actionsHtml}</div>
        ${editForm}`;
    }

    function toggleEditForm(idx) {
      editFormVisible = !editFormVisible;
      renderDetail(idx);
    }

    // Admin: direct save to Airtable
    async function adminSaveEdit(idx) {
      const m = allMembers[idx];
      const msgEl = document.getElementById('edit-msg');
      const submitBtn = document.getElementById('edit-submit-btn');

      const newName = document.getElementById('edit-name').value.trim();
      const newPhone = document.getElementById('edit-phone').value.trim();
      const newEmail = document.getElementById('edit-email').value.trim();
      const newMemberNum = document.getElementById('edit-membernum').value.trim();
      const newPhotoUrl = document.getElementById('edit-photo-url').value.trim();

      const updates = {};
      if (newName && newName !== m.name) updates['FULL NAME'] = newName;
      if (newPhone !== m.phone) updates['CELL #'] = newPhone;
      if (newEmail !== m.email) updates['E-MAIL ADDRESS'] = newEmail;
      if (newMemberNum && newMemberNum !== String(m.memberNum)) updates['MEMBER #'] = parseInt(newMemberNum);
      if (newPhotoUrl) updates['PHOTO'] = [{ url: newPhotoUrl }];

      if (Object.keys(updates).length === 0) {
        msgEl.className = 'edit-msg error';
        msgEl.textContent = 'No changes detected';
        return;
      }

      submitBtn.disabled = true;
      msgEl.className = 'edit-msg';
      msgEl.textContent = 'Saving...';

      try {
        const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}/${m.recordId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields: updates })
        });
        if (!res.ok) throw new Error(`API error ${res.status}`);

        // Update local data
        if (updates['FULL NAME']) m.name = updates['FULL NAME'];
        if ('CELL #' in updates) m.phone = updates['CELL #'];
        if ('E-MAIL ADDRESS' in updates) m.email = updates['E-MAIL ADDRESS'];
        if (updates['MEMBER #']) m.memberNum = updates['MEMBER #'];

        msgEl.className = 'edit-msg success';
        msgEl.textContent = 'Saved!';
        editFormVisible = false;
        setTimeout(() => renderDetail(idx), 1000);
        render(allMembers); // refresh cards behind overlay
      } catch (err) {
        msgEl.className = 'edit-msg error';
        msgEl.textContent = 'Failed to save. Try again.';
        submitBtn.disabled = false;
      }
    }

    // Member: submit change request
    async function submitChangeRequest(idx) {
      const m = allMembers[idx];
      const msgEl = document.getElementById('edit-msg');
      const submitBtn = document.getElementById('edit-submit-btn');

      const newName = document.getElementById('edit-name').value.trim();
      const newPhone = document.getElementById('edit-phone').value.trim();
      const newEmail = document.getElementById('edit-email').value.trim();
      const notes = document.getElementById('edit-notes').value.trim();
      const photoInput = document.getElementById('edit-photo');

      const changes = [];
      if (newName && newName !== m.name) changes.push(`Name: ${m.name} -> ${newName}`);
      if (newPhone && newPhone !== m.phone) changes.push(`Phone: ${m.phone || '(none)'} -> ${newPhone}`);
      if (newEmail && newEmail !== m.email) changes.push(`Email: ${m.email || '(none)'} -> ${newEmail}`);
      if (photoInput.files.length > 0) changes.push('New photo attached');
      if (notes) changes.push(`Notes: ${notes}`);

      if (changes.length === 0) {
        msgEl.className = 'edit-msg error';
        msgEl.textContent = 'No changes detected';
        return;
      }

      submitBtn.disabled = true;
      msgEl.className = 'edit-msg';
      msgEl.textContent = 'Submitting...';

      try {
        const fields = {
          'MEMBER NAME': m.name,
          'MEMBER RECORD ID': m.recordId,
          'REQUESTED CHANGES': changes.join('\n'),
          'STATUS': 'Pending',
          'SUBMITTED': new Date().toISOString(),
        };

        const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${CHANGES_TABLE}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields })
        });

        if (!res.ok) throw new Error(`API error ${res.status}`);
        const record = await res.json();

        if (photoInput.files.length > 0) {
          const file = photoInput.files[0];
          const reader = new FileReader();
          reader.onload = async function() {
            try {
              await fetch(`https://api.airtable.com/v0/${BASE_ID}/${CHANGES_TABLE}/${record.id}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${API_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  fields: { 'NEW PHOTO': [{ url: reader.result }] }
                })
              });
            } catch (e) {
              console.log('Photo upload skipped:', e.message);
            }
          };
          reader.readAsDataURL(file);
        }

        msgEl.className = 'edit-msg success';
        msgEl.textContent = 'Request submitted! Changes will appear after admin approval.';
        submitBtn.disabled = true;
      } catch (err) {
        msgEl.className = 'edit-msg error';
        msgEl.textContent = 'Failed to submit. Please try again.';
        submitBtn.disabled = false;
      }
    }

    function closeDetail() {
      editFormVisible = false;
      document.getElementById('overlay').classList.remove('open');
    }

    document.getElementById('overlay').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeDetail();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeDetail();
    });

    applyApprovedChanges().then(() => loadDirectory()).catch(err => {
      document.getElementById('content').innerHTML = `
        <div class="error">
          <p>Could not load directory</p>
          <p style="font-size:13px;color:#888;margin-top:8px;">${err.message}</p>
          <a href="https://airtable.com/appW7Df1qJlznxxtf/shrMlfdxvWotFV2lG">Open in Airtable instead &rarr;</a>
        </div>`;
      document.getElementById('count').textContent = '';
    });
  </script>
</body>
</html>
